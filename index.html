<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <title>Sistema de Control de Caja</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
        }
        nav {
            background-color: #333;
            color: white;
            padding: 10px;
            width: 200px;
            position: fixed;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        nav a:hover {
            background-color: #444;
        }
        .nav-icons {
            display: flex;
            justify-content: space-around;
        }
        .main {
            margin-left: 220px; /* espacio para el nav */
            padding: 20px;
            flex: 1;
        }
        aside {
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-y: auto;
            max-height: 300px; /* Altura máxima de la tabla */
            display: block;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            position: sticky;
            top: 0; /* Hace que el encabezado sea fijo en la parte superior */
            background-color: #f4f4f4;
            z-index: 10; /* Asegura que el encabezado esté por encima de las filas */
        }
        .ingreso {
            color: green;
        }
        .salida {
            color: red;
        }
        /* Para el input de búsqueda */
        #searchInput {
            margin-top: 10px;
            padding: 5px;
            width: 90%;
        }
    </style>
</head>
<body>

<nav>
    <h2>Control de Caja</h2>
    <div class="nav-icons">
        <a href="#" id="btnBuscar"><i class="fas fa-search"></i> Buscar</a>
        <a href="#" id="btnFiltrar"><i class="fas fa-filter"></i> Filtrar</a>
        <a href="#" id="btnExportarCSV"><i class="fas fa-file-csv"></i> Exportar</a>
    </div>
    <h3>Saldo Disponible:</h3>
    <p>ARS: <span id="saldoARSElement">0.00</span></p>
    <p>USD: <span id="saldoUSDElement">0.00</span></p>
    <p>EUR: <span id="saldoEURElement">0.00</span></p>
    <p>CLP: <span id="saldoCLPElement">0.00</span></p>
</nav>

<div class="main">
    <aside>
        <button id="btnIngreso">Registrar Ingreso</button>
        <button id="btnSalida">Registrar Salida</button>
    </aside>
    <input type="text" id="searchInput" placeholder="Buscar...">
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Monto</th>
                <th>Moneda</th>
                <th>Método de Pago</th>
            </tr>
        </thead>
        <tbody id="movimientosTabla"></tbody>
    </table>
</div>

<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let saldoARS = 0;
    let saldoUSD = 0;
    let saldoEUR = 0;
    let saldoCLP = 0;

    const saldoARSElement = document.getElementById('saldoARSElement');
    const saldoUSDElement = document.getElementById('saldoUSDElement');
    const saldoEURElement = document.getElementById('saldoEURElement');
    const saldoCLPElement = document.getElementById('saldoCLPElement');
    const movimientosTabla = document.getElementById('movimientosTabla');
    const searchInput = document.getElementById('searchInput');

    // Inicializa los saldos desde localStorage
    function cargarSaldos() {
        saldoARS = parseFloat(localStorage.getItem('saldoARS')) || 0;
        saldoUSD = parseFloat(localStorage.getItem('saldoUSD')) || 0;
        saldoEUR = parseFloat(localStorage.getItem('saldoEUR')) || 0;
        saldoCLP = parseFloat(localStorage.getItem('saldoCLP')) || 0;
        actualizarSaldos();
    }

    cargarSaldos();

    document.getElementById('btnIngreso').addEventListener('click', function() {
        Swal.fire({
            title: 'Registrar Ingreso',
            html: `
                <select id="categoriaIngreso" class="swal2-input">
                    <option value="Construcción">Construcción</option>
                    <option value="Diezmo">Diezmo</option>
                    <option value="Ofrenda">Ofrenda</option>
                    <option value="Viáticos">Viáticos</option>
                    <option value="Otra">Otra (Especificar)</option>
                </select>
                <input type="text" id="origenIngreso" class="swal2-input" placeholder="Especificar si es 'Otra'" style="display:none;">
                <select id="monedaIngreso" class="swal2-input">
                    <option value="ARS">ARS</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CLP">CLP</option>
                </select>
                <select id="metodoPagoIngreso" class="swal2-input">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Transferencia">Transferencia</option>
                </select>
                <select id="bancoIngreso" class="swal2-input" style="display:none;">
                    <option value="">Selecciona un banco</option>
                    <option value="Mercado Pago">Mercado Pago</option>
                    <option value="Banco Nación">Banco Nación</option>
                    <option value="Banco Credicoop">Banco Credicoop</option>
                </select>
                <input type="number" id="cantidadIngreso" class="swal2-input" placeholder="Cantidad">`,
            showCancelButton: true,
            confirmButtonText: 'Registrar Ingreso',
            preConfirm: () => {
                const categoria = document.getElementById('categoriaIngreso').value;
                const origenPersonalizado = document.getElementById('origenIngreso').value;
                const moneda = document.getElementById('monedaIngreso').value;
                const metodo = document.getElementById('metodoPagoIngreso').value;
                const banco = document.getElementById('bancoIngreso').value;
                const cantidadIngreso = parseFloat(document.getElementById('cantidadIngreso').value);
                const origen = categoria === 'Otra' ? origenPersonalizado : categoria;

                if (!origen || cantidadIngreso <= 0) {
                    Swal.showValidationMessage('Por favor ingrese una categoría válida y una cantidad mayor que 0');
                    return false;
                }
                return { origen, cantidadIngreso, metodo, moneda, banco };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const { origen, cantidadIngreso, metodo, moneda, banco } = result.value;
                registrarMovimiento('Ingreso', origen, cantidadIngreso, moneda, metodo, banco);
                actualizarSaldoMoneda(moneda, cantidadIngreso, 'Ingreso');
                guardarEnLocalStorage();
                actualizarSaldos();
            }
        });
    });

    document.getElementById('btnSalida').addEventListener('click', function() {
        Swal.fire({
            title: 'Registrar Salida',
            html: `
                <select id="categoriaSalida" class="swal2-input">
                    <option value="Irrigación">Irrigación</option>
                    <option value="Municipalidad">Municipalidad</option>
                    <option value="Servicios">Servicios</option>
                    <option value="Otro">Otro (Especificar)</option>
                </select>
                <input type="text" id="destinoSalida" class="swal2-input" placeholder="Especificar si es 'Otro'" style="display:none;">
                <select id="monedaSalida" class="swal2-input">
                    <option value="ARS">ARS</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CLP">CLP</option>
                </select>
                <select id="metodoPagoSalida" class="swal2-input">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Transferencia">Transferencia</option>
                </select>
                <select id="bancoSalida" class="swal2-input" style="display:none;">
                    <option value="">Selecciona un banco</option>
                    <option value="Mercado Pago">Mercado Pago</option>
                    <option value="Banco Nación">Banco Nación</option>
                    <option value="Banco Credicoop">Banco Credicoop</option>
                </select>
                <input type="number" id="cantidadSalida" class="swal2-input" placeholder="Cantidad">`,
            showCancelButton: true,
            confirmButtonText: 'Registrar Salida',
            preConfirm: () => {
                const categoria = document.getElementById('categoriaSalida').value;
                const destinoPersonalizado = document.getElementById('destinoSalida').value;
                const moneda = document.getElementById('monedaSalida').value;
                const metodo = document.getElementById('metodoPagoSalida').value;
                const banco = document.getElementById('bancoSalida').value;
                const cantidadSalida = parseFloat(document.getElementById('cantidadSalida').value);
                const destino = categoria === 'Otro' ? destinoPersonalizado : categoria;

                if (!destino || cantidadSalida <= 0) {
                    Swal.showValidationMessage('Por favor ingrese una categoría válida y una cantidad mayor que 0');
                    return false;
                }
                return { destino, cantidadSalida, metodo, moneda, banco };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const { destino, cantidadSalida, metodo, moneda, banco } = result.value;
                registrarMovimiento('Salida', destino, cantidadSalida, moneda, metodo, banco);
                actualizarSaldoMoneda(moneda, cantidadSalida, 'Salida');
                guardarEnLocalStorage();
                actualizarSaldos();
            }
        });
    });

    document.getElementById('btnFiltrar').addEventListener('click', function() {
        // Lógica de filtrado aquí
        Swal.fire({
            title: 'Filtrar Movimientos',
            html: `
                <input type="date" id="fechaDesde" class="swal2-input" placeholder="Desde">
                <input type="date" id="fechaHasta" class="swal2-input" placeholder="Hasta">
                <input type="text" id="descripcionFiltro" class="swal2-input" placeholder="Descripción">`,
            showCancelButton: true,
            confirmButtonText: 'Filtrar',
            preConfirm: () => {
                const fechaDesde = document.getElementById('fechaDesde').value;
                const fechaHasta = document.getElementById('fechaHasta').value;
                const descripcion = document.getElementById('descripcionFiltro').value;

                return { fechaDesde, fechaHasta, descripcion };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const { fechaDesde, fechaHasta, descripcion } = result.value;
                filtrarMovimientos(fechaDesde, fechaHasta, descripcion);
            }
        });
    });

    document.getElementById('btnBuscar').addEventListener('click', function() {
        // Lógica de búsqueda aquí
        const query = searchInput.value.toLowerCase();
        const rows = movimientosTabla.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const matches = Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(query));
            row.style.display = matches ? '' : 'none';
        });
    });

    document.getElementById('btnExportarCSV').addEventListener('click', function() {
        // Lógica para exportar CSV aquí
        const rows = Array.from(movimientosTabla.rows);
        const csvContent = rows.map(row => Array.from(row.cells).map(cell => cell.textContent).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'movimientos.csv');
        a.click();
        URL.revokeObjectURL(url);
    });

    function registrarMovimiento(tipo, descripcion, cantidad, moneda, metodo, banco) {
        const fecha = new Date().toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${fecha}</td>
            <td class="${tipo === 'Ingreso' ? 'ingreso' : 'salida'}">${tipo}</td>
            <td>${descripcion}</td>
            <td>${cantidad.toFixed(2)}</td>
            <td>${moneda}</td>
            <td>${metodo} ${banco ? `(${banco})` : ''}</td>
        `;
        movimientosTabla.appendChild(row);
    }

    function filtrarMovimientos(fechaDesde, fechaHasta, descripcion) {
        const rows = movimientosTabla.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const fecha = new Date(cells[0].textContent);
            const matchesFechaDesde = fechaDesde ? fecha >= new Date(fechaDesde) : true;
            const matchesFechaHasta = fechaHasta ? fecha <= new Date(fechaHasta) : true;
            const matchesDescripcion = descripcion ? cells[2].textContent.toLowerCase().includes(descripcion.toLowerCase()) : true;

            row.style.display = matchesFechaDesde && matchesFechaHasta && matchesDescripcion ? '' : 'none';
        });
    }

    function actualizarSaldoMoneda(moneda, cantidad, tipo) {
        if (tipo === 'Ingreso') {
            if (moneda === 'ARS') saldoARS += cantidad;
            else if (moneda === 'USD') saldoUSD += cantidad;
            else if (moneda === 'EUR') saldoEUR += cantidad;
            else if (moneda === 'CLP') saldoCLP += cantidad;
        } else {
            if (moneda === 'ARS') saldoARS -= cantidad;
            else if (moneda === 'USD') saldoUSD -= cantidad;
            else if (moneda === 'EUR') saldoEUR -= cantidad;
            else if (moneda === 'CLP') saldoCLP -= cantidad;
        }
    }

    function actualizarSaldos() {
        saldoARSElement.textContent = saldoARS.toFixed(2);
        saldoUSDElement.textContent = saldoUSD.toFixed(2);
        saldoEURElement.textContent = saldoEUR.toFixed(2);
        saldoCLPElement.textContent = saldoCLP.toFixed(2);
    }

    function guardarEnLocalStorage() {
        localStorage.setItem('saldoARS', saldoARS);
        localStorage.setItem('saldoUSD', saldoUSD);
        localStorage.setItem('saldoEUR', saldoEUR);
        localStorage.setItem('saldoCLP', saldoCLP);
    }

    // Inicializar API del dólar blue
    async function obtenerDolarBlue() {
        try {
            const response = await fetch('https://api-dolar-argentina.herokuapp.com/api/dolarblue');
            const data = await response.json();
            console.log(data); // Puedes manejar la data aquí
        } catch (error) {
            console.error('Error al obtener el dólar blue:', error);
        }
    }

    obtenerDolarBlue();

    // Muestra la tabla al cargar la página
    window.onload = () => {
        cargarSaldos();
        obtenerDolarBlue();
    };

    // Navegación con Tab y Enter
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const activeElement = document.activeElement;
            if (activeElement.id === 'searchInput') {
                document.getElementById('btnBuscar').click();
            } else if (activeElement.id === 'btnIngreso') {
                document.getElementById('btnIngreso').click();
            } else if (activeElement.id === 'btnSalida') {
                document.getElementById('btnSalida').click();
            }
        }
    });

    // Mostrar campos adicionales según selección
    document.getElementById('categoriaIngreso').addEventListener('change', function() {
        const origenInput = document.getElementById('origenIngreso');
        origenInput.style.display = this.value === 'Otra' ? 'block' : 'none';
    });

    document.getElementById('categoriaSalida').addEventListener('change', function() {
        const destinoInput = document.getElementById('destinoSalida');
        destinoInput.style.display = this.value === 'Otro' ? 'block' : 'none';
        const isServicios = this.value === 'Servicios';
        const serviciosList = `
            <select id="servicioSalida" class="swal2-input" style="${isServicios ? 'display:block;' : 'display:none;'}">
                <option value="Ecogas">Ecogas</option>
                <option value="Edemsa">Edemsa</option>
                <option value="Claro">Claro</option>
                <option value="Movistar">Movistar</option>
                <option value="ECI">ECI</option>
                <option value="Aguas Mendocinas">Aguas Mendocinas</option>
                <option value="Emergencias">Emergencias</option>
                <option value="Monotributo">Monotributo</option>
                <option value="Galeno">Galeno</option>
                <option value="Swiss Medical">Swiss Medical</option>
            </select>
        `;
        destinoInput.insertAdjacentHTML('afterend', serviciosList);
    });

    function cargarSaldos() {
        saldoARS = parseFloat(localStorage.getItem('saldoARS')) || 0;
        saldoUSD = parseFloat(localStorage.getItem('saldoUSD')) || 0;
        saldoEUR = parseFloat(localStorage.getItem('saldoEUR')) || 0;
        saldoCLP = parseFloat(localStorage.getItem('saldoCLP')) || 0;
        actualizarSaldos();
    }
</script>
